name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.1.0, 0.2.0-beta.1)"
        required: true
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: nexus-explorer

jobs:
  build-macos:
    name: Build (macOS ${{ matrix.target }})
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Generate app icon
        run: |
          brew install librsvg
          mkdir -p AppIcon.iconset
          for size in 16 32 64 128 256 512; do
            rsvg-convert -w $size -h $size assets/app-icon.svg -o "AppIcon.iconset/icon_${size}x${size}.png"
            double=$((size * 2))
            if [ $double -le 1024 ]; then
              rsvg-convert -w $double -h $double assets/app-icon.svg -o "AppIcon.iconset/icon_${size}x${size}@2x.png"
            fi
          done
          iconutil -c icns AppIcon.iconset -o AppIcon.icns

      - name: Create app bundle
        run: |
          APP_NAME="Nexus Explorer"
          mkdir -p "${APP_NAME}.app/Contents/MacOS"
          mkdir -p "${APP_NAME}.app/Contents/Resources"

          cp "target/${{ matrix.target }}/release/${BINARY_NAME}" "${APP_NAME}.app/Contents/MacOS/Nexus Explorer"
          cp AppIcon.icns "${APP_NAME}.app/Contents/Resources/AppIcon.icns"

          if [ -d "assets" ]; then
            cp -r assets "${APP_NAME}.app/Contents/Resources/"
          fi

          cat > "${APP_NAME}.app/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>Nexus Explorer</string>
              <key>CFBundleIdentifier</key>
              <string>com.nexus.explorer</string>
              <key>CFBundleName</key>
              <string>Nexus Explorer</string>
              <key>CFBundleDisplayName</key>
              <string>Nexus Explorer</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>12.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.utilities</string>
          </dict>
          </plist>
          PLIST

          # Update version in plist
          VERSION="${GITHUB_REF_NAME#v}"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" "${APP_NAME}.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "${APP_NAME}.app/Contents/Info.plist"

      - name: Import signing certificate
        if: ${{ env.MACOS_CERTIFICATE != '' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PWD: ${{ secrets.KEYCHAIN_PWD }}
        run: |
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PWD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PWD" build.keychain
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" build.keychain
          rm certificate.p12

      - name: Code sign app bundle
        if: ${{ env.MACOS_CERTIFICATE != '' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          codesign --force --options runtime --sign "$SIGNING_IDENTITY" --deep "Nexus Explorer.app"
          codesign --verify --verbose "Nexus Explorer.app"

      - name: Create DMG
        run: |
          hdiutil create -volname "Nexus Explorer" -srcfolder "Nexus Explorer.app" -ov -format UDZO "NexusExplorer-${{ matrix.target }}.dmg"

      - name: Code sign DMG
        if: ${{ env.MACOS_CERTIFICATE != '' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          codesign --force --sign "$SIGNING_IDENTITY" "NexusExplorer-${{ matrix.target }}.dmg"

      - name: Notarize DMG
        if: ${{ env.APPLE_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PWD: ${{ secrets.APPLE_ID_PWD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit "NexusExplorer-${{ matrix.target }}.dmg" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PWD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          xcrun stapler staple "NexusExplorer-${{ matrix.target }}.dmg"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-macos-${{ matrix.target }}
          path: NexusExplorer-${{ matrix.target }}.dmg

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install icon tools
        run: choco install imagemagick -y

      - name: Generate Windows icon
        shell: pwsh
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          magick convert -background none assets/app-icon.svg -define icon:auto-resize=256,128,64,48,32,16 assets/app-icon.ico

      - name: Build
        run: cargo build --release

      - name: Create distribution
        shell: bash
        run: |
          mkdir -p dist
          cp "target/release/${BINARY_NAME}.exe" "dist/Nexus Explorer.exe"
          cp assets/app-icon.ico dist/
          if [ -d "assets" ]; then
            cp -r assets dist/
          fi

      - name: Create ZIP
        run: Compress-Archive -Path dist/* -DestinationPath NexusExplorer-windows-x86_64.zip

      - name: Install WiX Toolset
        run: |
          dotnet tool install --global wix --version 5.0.0
          wix extension add WixToolset.UI.wixext/5.0.0 -g

      - name: Create MSI installer
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          if ($version -match '-') { $version = $version.Split('-')[0] }

          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
            <Package Name="Nexus Explorer" 
                     Manufacturer="Nexus Explorer Team" 
                     Version="$version" 
                     UpgradeCode="6B29FC40-CA47-1067-B31D-00DD010662DA"
                     Scope="perMachine">
              
              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
              <MediaTemplate EmbedCab="yes" />
              
              <StandardDirectory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="Nexus Explorer">
                  <Component Id="MainExecutable" Guid="6B29FC40-CA47-1067-B31D-00DD010662DB">
                    <File Id="NexusExplorerExe" Source="dist\Nexus Explorer.exe" KeyPath="yes" />
                  </Component>
                  <Component Id="AppIcon" Guid="6B29FC40-CA47-1067-B31D-00DD010662DC">
                    <File Id="AppIconIco" Source="dist\app-icon.ico" />
                  </Component>
                </Directory>
              </StandardDirectory>
              
              <StandardDirectory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="Nexus Explorer">
                  <Component Id="ApplicationShortcut" Guid="6B29FC40-CA47-1067-B31D-00DD010662DD">
                    <Shortcut Id="ApplicationStartMenuShortcut"
                              Name="Nexus Explorer"
                              Target="[INSTALLFOLDER]Nexus Explorer.exe"
                              WorkingDirectory="INSTALLFOLDER"
                              Icon="AppIcon.ico" />
                    <RemoveFolder Id="CleanUpShortCut" On="uninstall" />
                    <RegistryValue Root="HKCU" Key="Software\NexusExplorer" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                  </Component>
                </Directory>
              </StandardDirectory>
              
              <Icon Id="AppIcon.ico" SourceFile="dist\app-icon.ico" />
              
              <Feature Id="ProductFeature" Title="Nexus Explorer" Level="1">
                <ComponentRef Id="MainExecutable" />
                <ComponentRef Id="AppIcon" />
                <ComponentRef Id="ApplicationShortcut" />
              </Feature>
              
              <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
            </Package>
          </Wix>
          "@ | Out-File -FilePath "installer.wxs" -Encoding UTF8

          wix build installer.wxs -o NexusExplorer-windows-x86_64.msi -ext WixToolset.UI.wixext

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-windows-x86_64-zip
          path: NexusExplorer-windows-x86_64.zip

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-windows-x86_64-msi
          path: NexusExplorer-windows-x86_64.msi

  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libwayland-dev \
            libgtk-3-dev \
            libssl-dev \
            libvulkan-dev \
            librsvg2-bin \
            pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build
        run: cargo build --release

      - name: Create distribution
        run: |
          mkdir -p dist/nexus-explorer
          mkdir -p dist/nexus-explorer/icons/hicolor/{16x16,32x32,48x48,64x64,128x128,256x256,512x512}/apps

          cp "target/release/${BINARY_NAME}" dist/nexus-explorer/nexus-explorer
          chmod +x dist/nexus-explorer/nexus-explorer

          # Generate PNG icons at various sizes
          for size in 16 32 48 64 128 256 512; do
            rsvg-convert -w $size -h $size assets/app-icon.svg -o "dist/nexus-explorer/icons/hicolor/${size}x${size}/apps/nexus-explorer.png"
          done

          # Copy scalable SVG
          mkdir -p dist/nexus-explorer/icons/hicolor/scalable/apps
          cp assets/app-icon.svg dist/nexus-explorer/icons/hicolor/scalable/apps/nexus-explorer.svg

          if [ -d "assets" ]; then
            cp -r assets dist/nexus-explorer/
          fi

          cat > dist/nexus-explorer/nexus-explorer.desktop << 'EOF'
          [Desktop Entry]
          Name=Nexus Explorer
          Comment=A blazing-fast file explorer
          Exec=nexus-explorer
          Icon=nexus-explorer
          Type=Application
          Categories=System;FileManager;Utility;
          MimeType=inode/directory;
          Terminal=false
          EOF

          cat > dist/nexus-explorer/install.sh << 'EOF'
          #!/bin/bash
          set -e
          PREFIX="${PREFIX:-/usr/local}"
          install -Dm755 nexus-explorer "$PREFIX/bin/nexus-explorer"
          install -Dm644 nexus-explorer.desktop "$PREFIX/share/applications/nexus-explorer.desktop"
          for size in 16 32 48 64 128 256 512; do
            install -Dm644 "icons/hicolor/${size}x${size}/apps/nexus-explorer.png" \
              "$PREFIX/share/icons/hicolor/${size}x${size}/apps/nexus-explorer.png"
          done
          install -Dm644 icons/hicolor/scalable/apps/nexus-explorer.svg \
            "$PREFIX/share/icons/hicolor/scalable/apps/nexus-explorer.svg"
          echo "Installed to $PREFIX"
          EOF
          chmod +x dist/nexus-explorer/install.sh

          tar -czvf NexusExplorer-linux-x86_64.tar.gz -C dist nexus-explorer

      - name: Create AppImage
        run: |
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          cp dist/nexus-explorer/nexus-explorer AppDir/usr/bin/
          cp dist/nexus-explorer/nexus-explorer.desktop AppDir/
          cp dist/nexus-explorer/nexus-explorer.desktop AppDir/usr/share/applications/
          rsvg-convert -w 256 -h 256 assets/app-icon.svg -o AppDir/nexus-explorer.png
          cp AppDir/nexus-explorer.png AppDir/usr/share/icons/hicolor/256x256/apps/

          # Create AppRun
          cat > AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/nexus-explorer" "$@"
          APPRUN
          chmod +x AppDir/AppRun

          # Extract appimagetool and run without FUSE
          ./appimagetool-x86_64.AppImage --appimage-extract
          ARCH=x86_64 ./squashfs-root/AppRun AppDir NexusExplorer-linux-x86_64.AppImage

      - name: Create DEB package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p deb/DEBIAN
          mkdir -p deb/usr/bin
          mkdir -p deb/usr/share/applications
          mkdir -p deb/usr/share/icons/hicolor/256x256/apps

          cp dist/nexus-explorer/nexus-explorer deb/usr/bin/
          cp dist/nexus-explorer/nexus-explorer.desktop deb/usr/share/applications/
          rsvg-convert -w 256 -h 256 assets/app-icon.svg -o deb/usr/share/icons/hicolor/256x256/apps/nexus-explorer.png

          cat > deb/DEBIAN/control << EOF
          Package: nexus-explorer
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Nexus Explorer Team <augani@icloud.com>
          Description: A blazing-fast, GPU-accelerated file explorer
           Built with Rust and GPUI for maximum performance.
          EOF

          dpkg-deb --build deb NexusExplorer-linux-x86_64.deb

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-linux-x86_64-tar
          path: NexusExplorer-linux-x86_64.tar.gz

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-linux-x86_64-appimage
          path: NexusExplorer-linux-x86_64.AppImage

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-linux-x86_64-deb
          path: NexusExplorer-linux-x86_64.deb

  release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Determine if prerelease
        id: prerelease
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.prerelease }}" == "true" ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/nexus-macos-x86_64-apple-darwin/NexusExplorer-x86_64-apple-darwin.dmg
            artifacts/nexus-macos-aarch64-apple-darwin/NexusExplorer-aarch64-apple-darwin.dmg
            artifacts/nexus-windows-x86_64-zip/NexusExplorer-windows-x86_64.zip
            artifacts/nexus-windows-x86_64-msi/NexusExplorer-windows-x86_64.msi
            artifacts/nexus-linux-x86_64-tar/NexusExplorer-linux-x86_64.tar.gz
            artifacts/nexus-linux-x86_64-appimage/NexusExplorer-linux-x86_64.AppImage
            artifacts/nexus-linux-x86_64-deb/NexusExplorer-linux-x86_64.deb
          generate_release_notes: true
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
          name: Nexus Explorer ${{ github.ref_name }}
