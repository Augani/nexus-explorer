# Implementation Plan

- [x] 1. Project Setup and Core Types
  - [x] 1.1 Initialize Cargo project with GPUI and dependencies
    - Create `Cargo.toml` with gpui, tokio, jwalk, flume, nucleo, notify, image, systemicons, bincode, thiserror, lru dependencies
    - Set up workspace structure: `src/main.rs`, `src/app/`, `src/models/`, `src/views/`, `src/io/`, `src/utils/`
    - _Requirements: 9.1, 9.2_
  - [x] 1.2 Define core data types and error handling
    - Implement `FileEntry`, `LoadState`, `CachedDirectory`, `FsEvent`, `IconKey` structs
    - Implement `FileSystemError` enum with thiserror
    - Implement `Result<T>` type alias
    - _Requirements: 2.3, 10.1_
  - [x] 1.3 Write property test for FileEntry serialization round-trip
    - **Property 21: FileEntry Serialization Round-Trip**
    - **Validates: Requirements 10.1, 10.4**
  - [x] 1.4 Write property test for corrupted data rejection
    - **Property 22: Corrupted Data Rejection**
    - **Validates: Requirements 10.2**

- [x] 2. FileSystem Model - Core State Management
  - [x] 2.1 Implement FileSystem struct with basic state
    - Create `FileSystem` struct with `current_path`, `entries`, `state`, `request_id` fields
    - Implement `new()`, `entries()`, `current_path()`, `state()` methods
    - _Requirements: 1.1, 1.2_
  - [x] 2.2 Implement generational ID tracking
    - Add `request_id` increment on each navigation request
    - Implement ID validation for async operation completion
    - _Requirements: 1.5, 8.1, 8.2, 8.3_
  - [x] 2.3 Write property test for generational ID monotonicity
    - **Property 4: Generational ID Monotonicity and Validation**
    - **Validates: Requirements 1.5, 8.1, 8.2, 8.3**
  - [x] 2.4 Implement LRU cache for directory state
    - Add `LruCache<PathBuf, CachedDirectory>` field
    - Implement cache lookup and insertion
    - Store generation with cached entries
    - _Requirements: 1.4, 8.4_
  - [x] 2.5 Write property test for cache hit behavior
    - **Property 3: Cache Hit Returns Cached Data**
    - **Validates: Requirements 1.4**
  - [x] 2.6 Write property test for cache generation storage
    - **Property 20: Cache Generation Stored**
    - **Validates: Requirements 8.4**

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Directory Traversal Pipeline
  - [x] 4.1 Implement async traversal with jwalk
    - Create `traversal.rs` with jwalk integration
    - Implement `spawn_blocking` wrapper for Tokio pool
    - Stream results through `flume::Sender`
    - _Requirements: 3.1, 3.4_
  - [x] 4.2 Implement batch aggregator
    - Create `pipeline.rs` with batch collection logic
    - Implement 100-item OR 16ms flush threshold
    - Deliver batched `Vec<FileEntry>` to UI thread
    - _Requirements: 1.3, 3.3_
  - [x] 4.3 Write property test for batch size bounds
    - **Property 2: Batch Size Bounds**
    - **Validates: Requirements 1.3, 3.3**
  - [x] 4.4 Implement sorted traversal results
    - Configure jwalk for parallel sorting
    - Support sort by name, size, date
    - _Requirements: 3.2_
  - [x] 4.5 Write property test for traversal results sorted
    - **Property 8: Traversal Results Sorted**
    - **Validates: Requirements 3.2**
  - [x] 4.6 Wire traversal to FileSystem model
    - Implement `load_path()` method
    - Connect batch receiver to model updates
    - Validate request_id before applying updates
    - _Requirements: 1.1, 1.5_

- [x] 5. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. IconCache Model
  - [x] 6.1 Implement IconCache struct with LRU eviction
    - Create `IconCache` with `HashMap<IconKey, RenderImage>` and `LruCache`
    - Implement `max_entries` bound
    - Implement `get_icon()`, `get_or_default()` methods
    - _Requirements: 4.1, 4.4_
  - [x] 6.2 Write property test for icon cache miss returns default
    - **Property 9: Icon Cache Miss Returns Default**
    - **Validates: Requirements 4.1**
  - [x] 6.3 Write property test for LRU eviction bounds
    - **Property 12: LRU Eviction Bounds Cache Size**
    - **Validates: Requirements 4.4**
  - [x] 6.4 Implement RGBA to BGRA conversion
    - Create `icons.rs` utility module
    - Implement pixel format conversion function
    - _Requirements: 4.2_
  - [x] 6.5 Write property test for RGBA to BGRA conversion
    - **Property 10: RGBA to BGRA Conversion**
    - **Validates: Requirements 4.2**
  - [x] 6.6 Implement async icon fetch pipeline
    - Queue fetch requests for uncached icons
    - Decode images on background thread using `image` crate
    - Apply BGRA conversion before GPU upload
    - Update cache and remove from pending on completion
    - _Requirements: 4.2, 4.3_
  - [x] 6.7 Write property test for icon fetch completion
    - **Property 11: Icon Fetch Completion Updates Cache**
    - **Validates: Requirements 4.3**

- [x] 7. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 8. SearchEngine Model
  - [x] 8.1 Implement SearchEngine with nucleo integration
    - Create `SearchEngine` struct wrapping `Nucleo<PathBuf>`
    - Store `Injector` handle for incremental indexing
    - Implement `set_pattern()`, `snapshot()`, `inject()`, `clear()` methods
    - _Requirements: 5.1, 5.5_
  - [x] 8.2 Write property test for search pattern update
    - **Property 13: Search Pattern Update**
    - **Validates: Requirements 5.1**
  - [x] 8.3 Write property test for injected items searchable
    - **Property 15: Injected Items Searchable**
    - **Validates: Requirements 5.5**
  - [x] 8.4 Implement SearchSnapshot with match positions
    - Create `SearchSnapshot` and `MatchedItem` structs
    - Extract match positions from nucleo results
    - _Requirements: 5.2_
  - [x] 8.5 Write property test for match positions validity
    - **Property 14: Match Positions Validity**
    - **Validates: Requirements 5.2**

- [x] 9. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 10. FileList View with Virtualization
  - [x] 10.1 Implement FileListDelegate for virtualized rendering
    - Create `FileList` view implementing `ListDelegate`
    - Implement `item_count()` returning total entries
    - Implement `render_item()` for single row rendering
    - _Requirements: 2.1_
  - [x] 10.2 Implement visible range calculation
    - Calculate `start` and `end` indices from viewport and scroll
    - Add buffer for smooth scrolling
    - _Requirements: 2.4_
  - [x] 10.3 Write property test for virtualization bounds
    - **Property 5: Virtualization Bounds**
    - **Validates: Requirements 2.1**
  - [x] 10.4 Write property test for visible range calculation
    - **Property 7: Visible Range Calculation**
    - **Validates: Requirements 2.4**
  - [x] 10.5 Implement file entry row rendering
    - Render file name, formatted size, formatted date
    - Request icon from IconCache
    - _Requirements: 2.3_
  - [x] 10.6 Write property test for rendered entry completeness
    - **Property 6: Rendered Entry Completeness**
    - **Validates: Requirements 2.3**
  - [x] 10.7 Implement search result highlighting
    - Apply highlight styling to matched character positions
    - _Requirements: 5.3_

- [x] 11. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 12. Platform File System Monitoring
  - [x] 12.1 Implement Watcher trait and platform abstraction
    - Define `Watcher` trait with `watch()`, `unwatch()`, `poll_events()`
    - Define `PlatformFs` trait for platform detection
    - _Requirements: 6.1, 6.2, 6.3_
  - [x] 12.2 Implement notify-based watcher for macOS/Linux
    - Create `macos.rs` and `linux.rs` platform modules
    - Wrap notify crate with Watcher trait
    - _Requirements: 6.2, 6.3_
  - [x] 12.3 Implement event coalescing
    - Debounce rapid events on same path
    - Configurable coalescing window (default 50ms)
    - _Requirements: 6.5_
  - [x] 12.4 Write property test for event coalescing
    - **Property 17: Event Coalescing**
    - **Validates: Requirements 6.5**
  - [x] 12.5 Wire file events to FileSystem model
    - Process FsEvent::Created, Modified, Deleted, Renamed
    - Update entries and trigger UI refresh
    - _Requirements: 6.4_
  - [x] 12.6 Write property test for file event updates
    - **Property 16: File Event Updates Entries**
    - **Validates: Requirements 6.4**

- [x] 13. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 14. Windows NTFS Acceleration (Platform-Specific)
  - [x] 14.1 Implement MFT parser
    - Create `windows.rs` platform module
    - Parse $MFT to build file index
    - Construct `HashMap<FileReferenceNumber, FileNode>`
    - _Requirements: 7.1, 7.2_
  - [x] 14.2 Implement path reconstruction from MFT
    - Traverse parent references to build full paths
    - Cache reconstructed paths
    - _Requirements: 7.2_
  - [x] 14.3 Write property test for MFT path reconstruction
    - **Property 18: MFT Index Path Reconstruction**
    - **Validates: Requirements 7.1, 7.2**
  - [x] 14.4 Implement USN Journal monitor
    - Open handle to USN Journal
    - Read new records with FSCTL_READ_USN_JOURNAL
    - Update in-memory index on events
    - _Requirements: 7.3_
  - [x] 14.5 Write property test for MFT event consistency
    - **Property 19: MFT Index Event Consistency**
    - **Validates: Requirements 7.3**
  - [x] 14.6 Implement MFT index serialization
    - Serialize index to disk with bincode
    - Load on startup for faster initialization
    - _Requirements: 10.3_
  - [x] 14.7 Write property test for MFT serialization round-trip
    - **Property 23: MFT Index Serialization Round-Trip**
    - **Validates: Requirements 10.3, 10.4**

- [x] 15. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 16. Workspace View and Application Shell
  - [x] 16.1 Implement Workspace root view
    - Create `Workspace` view as root container
    - Manage layout panes (Sidebar, FileList, Preview)
    - Hold Model handles for FileSystem, IconCache, SearchEngine
    - _Requirements: 9.1_
  - [x] 16.2 Implement application initialization
    - Initialize GPUI App and Window
    - Spawn Tokio runtime on dedicated thread
    - Pre-load default icons into IconCache
    - Begin loading home directory asynchronously
    - _Requirements: 9.2, 9.3, 9.4_
  - [x] 16.3 Implement GlobalSettings
    - Create `GlobalSettings` struct for user preferences
    - Register as GPUI global state
    - Support show hidden files, sort order, theme
    - _Requirements: 2.3_
  - [x] 16.4 Write property test for loading state consistency
    - **Property 1: Loading State Consistency**
    - **Validates: Requirements 1.2**

- [x] 17. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
